<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virus Game - Multiplayer</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.jpg">
</head>
<body>
    <div class="main-container">
        <!-- Sidebar for controls and online users -->
        <div id="sidebar">
            <!-- Theme toggle icon -->
            <div id="theme-toggle" class="theme-toggle" title="Toggle dark theme">
                <span class="theme-icon">üåô</span>
            </div>

            <!-- Language toggle icon -->
            <div id="lang-toggle" class="lang-toggle" title="Change language / Sprache √§ndern">
                <span class="lang-icon">EN</span>
            </div>

            <!-- Help button -->
            <div id="help-button" class="help-button" title="Game Rules & Tutorial">
                <span class="help-icon">‚ùì</span>
            </div>

            <div id="connection-status" class="disconnected">Connecting...</div>
            <div id="welcome-message">Connecting...</div>

            <!-- Game Mode Selector -->
            <div class="sidebar-section">
                <h3>Game Mode</h3>
                <div class="game-mode-toggle">
                    <button id="mode-1v1" class="mode-button active">1v1</button>
                    <button id="mode-multiplayer" class="mode-button">Multiplayer</button>
                </div>
            </div>

            <!-- Game settings -->
            <div class="sidebar-section">
                <h3>Game Settings</h3>
                <div class="settings-group">
                    <label for="rows-input">Rows:</label>
                    <input type="number" id="rows-input" value="10" min="5" max="50">
                </div>
                <div class="settings-group">
                    <label for="cols-input">Cols:</label>
                    <input type="number" id="cols-input" value="10" min="5" max="50">
                </div>
                <div class="settings-group" id="ai-enabled-group">
                    <label for="ai-enabled">
                        <input type="checkbox" id="ai-enabled">
                        vs AI
                    </label>
                </div>
                <div class="settings-group" id="ai-depth-setting" style="display: none;">
                    <label for="ai-depth-input">AI Depth:</label>
                    <input type="number" id="ai-depth-input" value="3" min="1" max="6" title="How many moves ahead AI thinks (1-6)">
                </div>
                <div class="settings-group" id="ai-time-setting" style="display: none;">
                    <label for="ai-time-input">AI Time Limit (ms):</label>
                    <input type="number" id="ai-time-input" value="5000" min="0" max="60000" step="1000" title="0 = fixed depth, >0 = iterative deepening with time limit">
                </div>
                <button id="new-game-button" class="sidebar-button">New Local Game</button>
            </div>

            <!-- Multiplayer Lobby Section (hidden by default) -->
            <div class="sidebar-section" id="multiplayer-section" style="display: none;">
                <h3>Multiplayer Lobbies</h3>
                <button id="create-lobby-button" class="sidebar-button">Create Lobby</button>
                <button id="refresh-lobbies-button" class="sidebar-button">Refresh Lobbies</button>
                <div id="lobbies-list">
                    <div class="no-lobbies">No lobbies available</div>
                </div>
            </div>

            <!-- Current Lobby View (hidden by default) -->
            <div class="sidebar-section" id="current-lobby-section" style="display: none;">
                <h3>Lobby</h3>
                <div id="lobby-details"></div>
                <button id="leave-lobby-button" class="sidebar-button">Leave Lobby</button>
                <button id="add-bot-button" class="sidebar-button" style="display: none;">Add Bot</button>
                <button id="start-game-button" class="sidebar-button" style="display: none;">Start Game</button>
            </div>

            <!-- AI Tuning (collapsible) -->
            <div class="sidebar-section" id="ai-tuning-section" style="display: none;">
                <h3 style="cursor: pointer;" id="ai-tuning-header">‚öôÔ∏è AI Strategy Weights <span style="float: right;">‚ñº</span></h3>
                <div id="ai-tuning-controls" style="display: none;">
                    <p style="font-size: 11px; color: #666; margin: 5px 0;">Optimized AI with 5 balanced parameters (all O(n)):</p>
                    <div class="settings-group">
                        <label for="coeff-material" title="Cells and fortifications">Material:</label>
                        <input type="number" id="coeff-material" value="100" min="0" max="200" step="10">
                    </div>
                    <div class="settings-group">
                        <label for="coeff-mobility" title="Number of available moves">Mobility:</label>
                        <input type="number" id="coeff-mobility" value="50" min="0" max="200" step="10">
                    </div>
                    <div class="settings-group">
                        <label for="coeff-position" title="Aggression + attack opportunities">Position:</label>
                        <input type="number" id="coeff-position" value="30" min="0" max="200" step="10">
                    </div>
                    <div class="settings-group">
                        <label for="coeff-redundancy" title="Network resilience (cells with 2+ connections)">Redundancy:</label>
                        <input type="number" id="coeff-redundancy" value="40" min="0" max="200" step="10">
                    </div>
                    <div class="settings-group">
                        <label for="coeff-cohesion" title="Territory cohesion (penalize gaps/holes)">Cohesion:</label>
                        <input type="number" id="coeff-cohesion" value="25" min="0" max="200" step="10">
                    </div>
                    <button id="reset-coeffs-button" class="sidebar-button" style="font-size: 11px;">Reset to Defaults</button>
                </div>
            </div>

            <!-- Online users -->
            <div class="sidebar-section users-section">
                <h3>Online Players</h3>
                <div id="users-list">
                    <div class="no-users">Connecting to server...</div>
                </div>
            </div>
        </div>

        <!-- Main game area -->
        <div id="main-content">
            <div id="game-container">
                <h1>Virus Game</h1>
                <div id="ai-progress" class="hidden">
                    <small>AI thinking: <span id="ai-progress-text">0/0</span></small>
                </div>
                <div id="game-board"></div>
                <div id="status"></div>
                <div id="game-controls">
                    <button id="resign-button" style="display: none;">Resign</button>
                    <button id="rematch-button">Request Rematch</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rules-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="rules-close">&times;</span>
            <h2>üéÆ Game Rules & How to Play</h2>

            <div class="modal-section">
                <h3>üéØ Goal</h3>
                <p>Eliminate all of your opponent's cells by spreading your virus across the board while protecting your base!</p>
            </div>

            <div class="modal-section">
                <h3>üìú Basic Rules</h3>
                <ul>
                    <li><strong>Each turn:</strong> You get 3 moves</li>
                    <li><strong>Valid moves:</strong> Place your cell on an empty space or attack opponent's cell (must be adjacent to your territory and connected to your base)</li>
                    <li><strong>Attacking:</strong> When you attack an opponent's cell, it becomes <strong>fortified</strong> (protected) and cannot be attacked again</li>
                    <li><strong>Winning:</strong> The first player to eliminate all opponent's cells wins!</li>
                </ul>
            </div>

            <div class="modal-section">
                <h3>üè∞ Cell Types</h3>
                <ul>
                    <li><strong>Base (green background):</strong> Your starting cell - cannot be attacked and must always stay connected to your territory</li>
                    <li><strong>Regular cells (X or O):</strong> Your normal territory cells</li>
                    <li><strong>Fortified cells (solid color):</strong> Protected cells that cannot be attacked (created when you attack opponent's cell)</li>
                    <li><strong>Killed cells (gray):</strong> Neutral/dead cells that can be claimed by either player</li>
                </ul>
            </div>

            <div class="modal-section">
                <h3>ü§ñ Playing with AI</h3>
                <ul>
                    <li>Check "vs AI" in Game Settings to play against the computer</li>
                    <li>Adjust AI Depth (1-6) to control difficulty</li>
                    <li>Higher depth = smarter AI but slower moves</li>
                    <li>Fine-tune AI strategy with AI Strategy Weights (for advanced players)</li>
                </ul>
            </div>

            <div class="modal-section">
                <h3>üë• Multiplayer</h3>
                <ul>
                    <li><strong>Challenge:</strong> Click "Challenge" next to an online player's name</li>
                    <li><strong>Accept:</strong> When challenged, a notification will appear - click "Accept" to start</li>
                    <li><strong>Your turn:</strong> The status will glow green when it's your turn</li>
                    <li><strong>Rematch:</strong> After the game ends, click "Request Rematch" to play again</li>
                </ul>
            </div>

            <div class="modal-actions">
                <button id="start-tutorial-btn" class="primary-btn">üìö Start Interactive Tutorial</button>
                <button id="close-rules-btn" class="secondary-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorial-modal" class="modal">
        <div class="modal-content tutorial-content">
            <div id="tutorial-step-content"></div>
            <div class="tutorial-controls">
                <button id="tutorial-prev-btn" class="secondary-btn">‚Üê Previous</button>
                <div id="tutorial-progress"></div>
                <button id="tutorial-next-btn" class="primary-btn">Next ‚Üí</button>
                <button id="tutorial-skip-btn" class="secondary-btn">Skip Tutorial</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Overlay (for highlighting elements) -->
    <div id="tutorial-overlay" class="tutorial-overlay"></div>
    <div id="tutorial-highlight" class="tutorial-highlight"></div>

    <!-- Notifications container -->
    <div id="notifications"></div>

    <!-- Footer -->
    <div id="footer">
        <div id="commit-sha">Commit: __COMMIT_SHA__ | Multiplayer v1.6</div>
    </div>

    <script src="translations.js?v=2.7"></script>
    <script src="script.js?v=2.7"></script>
    <script src="ai.js?v=2.7"></script>
    <script src="multiplayer.js?v=2.7"></script>
    <script src="lobby.js?v=2.7"></script>
    <script src="tutorial.js?v=2.7"></script>
    <script>
        // Theme toggle
        document.getElementById('theme-toggle').addEventListener('click', function() {
            document.body.classList.toggle('dark-theme');
            const icon = this.querySelector('.theme-icon');
            icon.textContent = document.body.classList.contains('dark-theme') ? '‚òÄÔ∏è' : 'üåô';
        });

        // Language toggle
        document.getElementById('lang-toggle').addEventListener('click', function() {
            const newLang = i18n.currentLanguage === 'en' ? 'de' : 'en';
            i18n.setLanguage(newLang);
            const icon = this.querySelector('.lang-icon');
            icon.textContent = newLang.toUpperCase();
        });

        // Help button - open rules modal
        document.getElementById('help-button').addEventListener('click', function() {
            document.getElementById('rules-modal').style.display = 'block';
        });

        // Close rules modal
        document.getElementById('rules-close').addEventListener('click', function() {
            document.getElementById('rules-modal').style.display = 'none';
        });

        document.getElementById('close-rules-btn').addEventListener('click', function() {
            document.getElementById('rules-modal').style.display = 'none';
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const rulesModal = document.getElementById('rules-modal');
            const tutorialModal = document.getElementById('tutorial-modal');
            if (event.target === rulesModal) {
                rulesModal.style.display = 'none';
            }
            if (event.target === tutorialModal) {
                tutorialModal.style.display = 'none';
                if (typeof Tutorial !== 'undefined') Tutorial.end();
            }
        });

        // Start tutorial button
        document.getElementById('start-tutorial-btn').addEventListener('click', function() {
            document.getElementById('rules-modal').style.display = 'none';
            if (typeof Tutorial !== 'undefined') Tutorial.start();
        });

        // Initialize multiplayer on page load
        document.addEventListener('DOMContentLoaded', () => {
            mpClient.connect();
            // Initialize lobby manager
            lobbyManager = new LobbyManager(mpClient);
        });

        // Handle rematch button
        document.getElementById('rematch-button').addEventListener('click', () => {
            mpClient.requestRematch();
        });
    </script>
</body>
</html>